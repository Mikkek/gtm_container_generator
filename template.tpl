___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Facebook Pixel Hændelse",
  "brand": {
    "id": "brand_dummy",
    "displayName": "",
    "thumbnail": "data:image/png;base64,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\u003d\u003d"
  },
  "description": "Modified version of this -\u003e https://github.com/facebookarchive/GoogleTagManager-WebTemplate-For-FacebookPixel",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "pixelId",
    "displayName": "Facebook Pixel ID(s)",
    "simpleValueType": true,
    "alwaysInSummary": true,
    "valueHint": "e.g. 12345678910",
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      },
      {
        "type": "REGEX",
        "args": [
          "^[0-9,]+$"
        ]
      }
    ]
  },
  {
    "type": "CHECKBOX",
    "name": "enhancedEcommerce",
    "checkboxText": "Enhanced Ecommerce dataLayer Integration",
    "simpleValueType": true,
    "help": "If you check this, then the Facebook pixel will populate \u003cstrong\u003eEvent Name\u003c/strong\u003e and \u003cstrong\u003eObject Properties\u003c/strong\u003e automatically from the last \u003ca href\u003d\"https://developers.google.com/tag-manager/enhanced-ecommerce\"\u003eecommerce\u003c/a\u003e object pushed into the dataLayer array."
  },
  {
    "type": "RADIO",
    "name": "eventName",
    "displayName": "Event Name",
    "radioItems": [
      {
        "value": "standard",
        "displayValue": "Standard"
      },
      {
        "value": "custom",
        "displayValue": "Custom"
      },
      {
        "value": "variable",
        "displayValue": "Variable"
      }
    ],
    "simpleValueType": true,
    "enablingConditions": [
      {
        "paramName": "enhancedEcommerce",
        "paramValue": false,
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "RADIO",
    "name": "eecEventName",
    "displayName": "Event Name",
    "radioItems": [
      {
        "value": "eec",
        "displayValue": "Set automatically from dataLayer"
      }
    ],
    "simpleValueType": true,
    "enablingConditions": [
      {
        "paramName": "enhancedEcommerce",
        "paramValue": true,
        "type": "EQUALS"
      }
    ],
    "help": "The Enhanced Ecommerce integration populates the Event Name automatically depending on what type of \u003cstrong\u003eecommerce\u003c/strong\u003e object was last pushed into dataLayer (\"view_item\" -\u003e \"ViewContent\", \"add_to_cart\" -\u003e \"AddToCart\", \"begin_checkout\" -\u003e \"InitiateCheckout\", \"purchase\" -\u003e \"Purchase\")."
  },
  {
    "type": "SELECT",
    "name": "consent",
    "displayName": "Consent Granted (GDPR)",
    "macrosInSelect": true,
    "selectItems": [
      {
        "value": true,
        "displayValue": "True"
      },
      {
        "value": false,
        "displayValue": "False"
      }
    ],
    "simpleValueType": true,
    "help": "If you set Consent Granted to \u003cstrong\u003efalse\u003c/strong\u003e, the pixel will not send any hits until a tag is fired where Consent Granted is set to \u003cstrong\u003etrue\u003c/strong\u003e. See \u003ca href\u003d\"https://developers.facebook.com/docs/facebook-pixel/implementation/gdpr/\"\u003ethis article\u003c/a\u003e for more information."
  },
  {
    "type": "CHECKBOX",
    "name": "advancedMatching",
    "checkboxText": "Enable Advanced Matching",
    "simpleValueType": true
  },
  {
    "type": "GROUP",
    "name": "dataProcessingOptionsGroup",
    "displayName": "Data Processing Options",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "LABEL",
        "name": "dpoInfo",
        "displayName": "Data Processing Options force this Facebook event to comply to regional regulations with regard to the processing and selling of user data. Read \u003ca href\u003d\"https://developers.facebook.com/docs/marketing-apis/data-processing-options\"\u003ethis\u003c/a\u003e for more information about how to configure this section."
      },
      {
        "type": "CHECKBOX",
        "name": "dpoLDU",
        "checkboxText": "Limited Data Use (LDU)",
        "simpleValueType": true
      },
      {
        "type": "TEXT",
        "name": "dpoCountry",
        "displayName": "Country",
        "simpleValueType": true,
        "defaultValue": 0,
        "enablingConditions": [
          {
            "paramName": "dpoLDU",
            "paramValue": true,
            "type": "EQUALS"
          }
        ],
        "valueValidators": [
          {
            "type": "NUMBER"
          }
        ]
      },
      {
        "type": "TEXT",
        "name": "dpoState",
        "displayName": "State",
        "simpleValueType": true,
        "defaultValue": 0,
        "enablingConditions": [
          {
            "paramName": "dpoLDU",
            "paramValue": true,
            "type": "EQUALS"
          }
        ],
        "valueValidators": [
          {
            "type": "NUMBER"
          }
        ]
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "advancedMatchingGroup",
    "displayName": "Customer Information Data Parameters",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "SIMPLE_TABLE",
        "name": "advancedMatchingList",
        "displayName": "",
        "simpleTableColumns": [
          {
            "defaultValue": "",
            "displayName": "Parameter name",
            "name": "name",
            "type": "SELECT",
            "selectItems": [
              {
                "value": "ct",
                "displayValue": "City"
              },
              {
                "value": "cn",
                "displayValue": "Country"
              },
              {
                "value": "db",
                "displayValue": "Date of Birth"
              },
              {
                "value": "em",
                "displayValue": "Email"
              },
              {
                "value": "external_id",
                "displayValue": "External ID"
              },
              {
                "value": "fn",
                "displayValue": "First Name"
              },
              {
                "value": "ge",
                "displayValue": "Gender"
              },
              {
                "value": "ln",
                "displayValue": "Last Name"
              },
              {
                "value": "ph",
                "displayValue": "Phone"
              },
              {
                "value": "st",
                "displayValue": "State"
              },
              {
                "value": "zp",
                "displayValue": "Zip Code"
              }
            ]
          },
          {
            "defaultValue": "",
            "displayName": "Parameter value",
            "name": "value",
            "type": "TEXT"
          }
        ],
        "newRowButtonText": "Add parameter",
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ]
      }
    ],
    "enablingConditions": [
      {
        "paramName": "advancedMatching",
        "paramValue": true,
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "objectPropertiesGroup",
    "displayName": "Object Properties",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "LABEL",
        "name": "enhancedEcommerceObject",
        "displayName": "\u003cstrong\u003eWarning!\u003c/strong\u003e Object properties are populated automatically based on the most recent \u003cstrong\u003eecommerce\u003c/strong\u003e object pushed into dataLayer. If you add properties here that are already set by the integration (content_type, contents, num_items, value, currency), then the properties you add here will override those set automatically by the integration!",
        "enablingConditions": [
          {
            "paramName": "enhancedEcommerce",
            "paramValue": true,
            "type": "EQUALS"
          }
        ]
      },
      {
        "type": "SELECT",
        "name": "objectPropertiesFromVariable",
        "displayName": "Load Properties From Variable",
        "macrosInSelect": true,
        "selectItems": [
          {
            "value": false,
            "displayValue": "False"
          }
        ],
        "simpleValueType": true,
        "help": "You can use a variable that returns a JavaScript object with the properties you want to use. This object will be merged with any additional properties you add via the table below. Any conflicts will be resolved in favor of the properties you add to the table."
      },
      {
        "type": "SIMPLE_TABLE",
        "name": "objectPropertyList",
        "simpleTableColumns": [
          {
            "defaultValue": "",
            "displayName": "Property Name",
            "name": "name",
            "type": "TEXT"
          },
          {
            "defaultValue": "",
            "displayName": "Property Value",
            "name": "value",
            "type": "TEXT"
          }
        ],
        "newRowButtonText": "Add property"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "moreSettingsGroup",
    "displayName": "More Settings",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "CHECKBOX",
        "name": "disableAutoConfig",
        "checkboxText": "Disable Automatic Configuration",
        "simpleValueType": true,
        "help": "Facebook collects some metadata (e.g. structured data) and user interactions (e.g. clicks) automatically. Check this box to disable this automatic configuration of the pixel."
      },
      {
        "type": "CHECKBOX",
        "name": "disablePushState",
        "checkboxText": "Disable History Event Tracking",
        "simpleValueType": true,
        "help": "The Facebook Pixel tracks history events (pushState and replaceState) automatically as PageViews. Check this box to prevent the pixel from tracking such events automatically."
      },
      {
        "type": "TEXT",
        "name": "eventId",
        "displayName": "Event ID",
        "simpleValueType": true,
        "help": "Set the Event ID parameter in case you are tracking the same event server-side as well. The Event ID can be used to deduplicate the same event if sent from multiple sources. See more \u003ca href\u003d\"https://developers.facebook.com/docs/marketing-api/conversions-api/deduplicate-pixel-and-server-events/\"\u003ehere\u003c/a\u003e."
      }
    ]
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

const createQueue = require('createQueue');
const callInWindow = require('callInWindow');
const aliasInWindow = require('aliasInWindow');
const copyFromWindow = require('copyFromWindow');
const setInWindow = require('setInWindow');
const injectScript = require('injectScript');
const makeTableMap = require('makeTableMap');
const makeNumber = require('makeNumber');
const getType = require('getType');
const copyFromDataLayer = require('copyFromDataLayer');
const math = require('Math');
const log = require('logToConsole');

const initIds = copyFromWindow('_fbq_gtm_ids') || [];
const pixelIds = data.pixelId;
const standardEventNames = ['AddPaymentInfo', 'AddToCart', 'AddToWishlist', 'CompleteRegistration', 'Contact', 'CustomizeProduct', 'Donate', 'FindLocation', 'InitiateCheckout', 'Lead', 'PageView', 'Purchase', 'Schedule', 'Search', 'StartTrial', 'SubmitApplication', 'Subscribe', 'ViewContent'];
const ecommerce = copyFromDataLayer('ecommerce', 1);

// Helper methods
const fail = msg => {
  log(msg);
  data.gtmOnFailure();
};

const mergeObj = (obj, obj2) => {
  for (let key in obj2) {
    if (obj2.hasOwnProperty(key)) {
      obj[key] = obj2[key];
    }
  }
  return obj;
};

const parseEecObj = prod => {
  return {
    id: prod.id,
    quantity: prod.quantity
  };
};

// Initialize EEC integration
let eventName, action, eecObjectProps;
if (data.enhancedEcommerce) {
  if (!ecommerce) return fail('Facebook Pixel: No valid "ecommerce" object found in dataLayer');
  if (ecommerce.view_item) { eventName = 'ViewContent'; action = 'view_item'; }
  else if (ecommerce.add_to_cart) { eventName = 'AddToCart'; action = 'add_to_cart'; }
  else if (ecommerce.begin_checkout) { eventName = 'InitiateCheckout'; action = 'begin_checkout'; }
  else if (ecommerce.purchase) { eventName = 'Purchase'; action = 'purchase'; }
  else return fail('Facebook Pixel: Most recently pushed "ecommerce" object must be one of types "view_item", "add_to_cart", "begin_checkout" or "purchase".');
  
  if (!ecommerce[action].products || getType(ecommerce[action].products) !== 'array') return fail('Facebook pixel: Most recently pushed "ecommerce" object did not have a valid "products" array.');
  eecObjectProps = {
    content_type: 'product',
    contents: ecommerce[action].products.map(parseEecObj),
    value: ecommerce[action].products.reduce((acc, cur) => {
      const curVal = math.round(makeNumber(cur.price || 0) * (cur.quantity || 1) * 100) / 100;
      return acc + curVal;
    }, 0.0),
    currency: ecommerce.currencyCode || 'USD'
  };
  if (['InitiateCheckout', 'Purchase'].indexOf(eventName) > -1) eecObjectProps.num_items = ecommerce[action].products.reduce((acc,cur) => {
    return acc + makeNumber(cur.quantity || 1);
  }, 0);
}

// Build the fbq() command arguments
const cidParams = data.advancedMatchingList && data.advancedMatchingList.length ? makeTableMap(data.advancedMatchingList, 'name', 'value') : {};
const objectProps = data.objectPropertyList && data.objectPropertyList.length ? makeTableMap(data.objectPropertyList, 'name', 'value') : {};
const objectPropsFromVar = getType(data.objectPropertiesFromVariable) === 'object' ? data.objectPropertiesFromVariable : {};
const mergedObjectProps = mergeObj(objectPropsFromVar, objectProps);
const finalObjectProps = mergeObj(eecObjectProps || {}, mergedObjectProps);
eventName = eventName || (data.eventName === 'custom' ? data.customEventName : (data.eventName === 'variable' ? data.variableEventName : data.standardEventName));

const command = standardEventNames.indexOf(eventName) === -1 ? 'trackSingleCustom' : 'trackSingle';
const consent = data.consent === false ? 'revoke' : 'grant';

// Utility function to use either fbq.queue[]
// (if the FB SDK hasn't loaded yet), or fbq.callMethod()
// if the SDK has loaded.
const getFbq = () => {
  // Return the existing 'fbq' global method if available
  let fbq = copyFromWindow('fbq');
  if (fbq) {
    return fbq;
  }
  
  // Initialize the 'fbq' global method to either use
  // fbq.callMethod or fbq.queue)
  setInWindow('fbq', function() {    
    const callMethod = copyFromWindow('fbq.callMethod.apply');
    if (callMethod) {           
      callInWindow('fbq.callMethod.apply', null, arguments); 
    } else {       
      callInWindow('fbq.queue.push', arguments);
    }
  });
  aliasInWindow('_fbq', 'fbq');
  
  // Create the fbq.queue
  createQueue('fbq.queue');
    
  // Return the global 'fbq' method, created above
  return copyFromWindow('fbq');
};

// Get reference to the global method
const fbq = getFbq();

fbq('consent', consent);

 // Set Data Processing Options
if (data.dpoLDU) {
  fbq('dataProcessingOptions', ['LDU'], makeNumber(data.dpoCountry), makeNumber(data.dpoState));
}

// Handle multiple, comma-separated pixel IDs,
// and initialize each ID if not done already.
pixelIds.split(',').forEach(pixelId => {
  if (initIds.indexOf(pixelId) === -1) {
    
    // If the user has chosen to disable automatic configuration
    if (data.disableAutoConfig) {
      fbq('set', 'autoConfig', false, pixelId);
    }
    
    // If the user has chosen to disable pushState and replaceState tracking
    if (data.disablePushState) {
      setInWindow('fbq.disablePushState', true);
    }
   	
    
    // Initialize pixel and store in global array
    fbq('init', pixelId, cidParams);

    // Monitoring agent string for Tag Setup
    fbq('set','agent','tmSimo-GTM-WebTemplate', pixelId);

    initIds.push(pixelId);
    setInWindow('_fbq_gtm_ids', initIds, true);
    
  }

  // Call the fbq() method with the parameters defined earlier
  if (data.eventId) {
    fbq(command, pixelId, eventName, finalObjectProps, {eventID: data.eventId});
  } else {
    fbq(command, pixelId, eventName, finalObjectProps);
  }
});

injectScript('https://connect.facebook.net/en_US/fbevents.js', data.gtmOnSuccess, data.gtmOnFailure, 'fbPixel');


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "fbq"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "_fbq_gtm"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "_fbq"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "_fbq_gtm_ids"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "fbq.callMethod.apply"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "fbq.queue.push"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "fbq.queue"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "fbq.disablePushState"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_data_layer",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedKeys",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "keyPatterns",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "ecommerce"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://connect.facebook.net/en_US/fbevents.js"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: Library is injected
  code: |-
    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('injectScript').wasCalledWith(scriptUrl, success, failure, 'fbPixel');
    assertApi('gtmOnSuccess').wasCalled();
- name: fbq does not exist - method created
  code: |-
    let fbq;

    mock('copyFromWindow', key => {
      if (key === 'fbq') return fbq;
    });

    mock('createQueue', key => {});

    mock('setInWindow', (key, val) => {
      if (key === 'fbq') fbq = val;
    });

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('aliasInWindow').wasCalledWith('_fbq', 'fbq');
    assertApi('setInWindow').wasCalled();
    assertApi('gtmOnSuccess').wasCalled();
- name: fbq exists - method copied
  code: |-
    mock('setInWindow', key => {
      if (key === 'fbq') fail('setInWindow called with fbq even though variable exists');
    });

    mock('createQueue', key => {});

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
- name: makeTableMap called
  code: |-
    mockData.advancedMatching = true;

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('makeTableMap').wasCalledWith(mockData.advancedMatchingList, 'name', 'value');
    assertApi('makeTableMap').wasCalledWith(mockData.objectPropertyList, 'name', 'value');
    assertApi('gtmOnSuccess').wasCalled();
- name: Consent set
  code: |-
    mock('copyFromWindow', key => {
      if (key === 'fbq') return function() {
        if (arguments[0] === 'consent') {
          assertThat(arguments[1], 'Consent set incorrectly').isEqualTo('grant');
        }
      };
    });

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
- name: DPO LDU set
  code: |-
    mockData.dpoLDU = true;
    mockData.dpoCountry = '0';
    mockData.dpoState = '0';

    mock('copyFromWindow', key => {
      if (key === 'fbq') return function() {
        if (arguments[0] === 'consent') {
          assertThat(arguments[1], 'Consent set incorrectly').isEqualTo('grant');
        }
        if (arguments[0] === 'dataProcessingOptions') {
          assertThat(arguments[1], 'LDU array value not set').isEqualTo(['LDU']);
          assertThat(arguments[2], 'LDU country not set').isEqualTo(0);
          assertThat(arguments[3], 'LDU state not set').isEqualTo(0);
        }
      };
    });

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
- name: DPO LDU not set
  code: |-
    mock('copyFromWindow', key => {
      if (key === 'fbq') return function() {
        if (arguments[0] === 'consent') {
          assertThat(arguments[1], 'Consent set incorrectly').isEqualTo('grant');
        }
        if (arguments[0] === 'dataProcessingOptions') {
          fail('dataProcessingOptions called even though DPO was not set');
        }
      };
    });

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
- name: Pixel IDs set - do not initialize
  code: |-
    mock('copyFromWindow', key => {
      if (key === '_fbq_gtm_ids') return ['12345', '23456'];
      if (key === 'fbq') return function() {
        if (arguments[0] === 'init') fail('init called even though pixel IDs already initialized');
      };
    });

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
- name: Pixel IDs not set - run init process
  code: "let index = 0;\nlet count = 0;\nlet _fbq_gtm_ids;\n\nmockData.advancedMatching\
    \ = true;\nmockData.disableAutoConfig = true;\nmockData.disablePushState = true;\n\
    \nmock('setInWindow', (key, val) => {\n  if (key === 'fbq.disablePushState') count\
    \ += 1;\n  if (key === '_fbq_gtm_ids') _fbq_gtm_ids = val;\n});\n\nconst initObj\
    \ = {\n  ct: 'Helsinki',\n  cn: 'Finland',\n  external_id: 'UserId'\n};\n\nmock('copyFromWindow',\
    \ key => {\n  if (key === 'fbq') return function() {\n    if (arguments[0] ===\
    \ 'set' && arguments[1] === 'autoConfig' && arguments[2] === false) {\n      assertThat(arguments[3],\
    \ 'autoConfig called with incorrect pixelId').isEqualTo(mockData.pixelId.split(',')[index]);\n\
    \    }\n    if (arguments[0] === 'set' && arguments[1] === 'agent') {\n      assertThat(arguments[2],\
    \ 'agent set with invalid value').isEqualTo('tmSimo-GTM-WebTemplate');\n     \
    \ assertThat(arguments[3], 'agent set with invalid pixel ID').isEqualTo(mockData.pixelId.split(',')[index]);\n\
    \      index += 1;\n    }\n    if (arguments[0] === 'init') {\n      assertThat(arguments[1],\
    \ 'init called with incorrect pixelId').isEqualTo(mockData.pixelId.split(',')[index]);\n\
    \      assertThat(arguments[2], 'init called with incorrect initObj').isEqualTo(initObj);\n\
    \    } \n  };\n});\n\n// Call runCode to run the template's code.\nrunCode(mockData);\n\
    \nassertThat(_fbq_gtm_ids, '_fbq_gtm_ids has incorrect contents').isEqualTo(mockData.pixelId.split(','));\n\
    assertThat(index, 'init called incorrect number of times: ' + index).isEqualTo(2);\n\
    assertThat(count, 'fbq.disablePushState called incorrect number of times: ' +\
    \ count).isEqualTo(2);\n\n// Verify that the tag finished successfully.\nassertApi('gtmOnSuccess').wasCalled();"
- name: Send standard event
  code: "const eventParams = {\n  prop1: 'val1',\n  prop2: 'val2'\n};\n\nlet index\
    \ = 0;\nmock('copyFromWindow', key => {\n  if (key === 'fbq') return function()\
    \ {\n    if (arguments[0] === 'trackSingle') {\n      assertThat(arguments[1],\
    \ 'trackSingle called with incorrect pixel ID').isEqualTo(mockData.pixelId.split(',')[index]);\n\
    \      assertThat(arguments[2], 'trackSingle called with incorrect event name').isEqualTo(mockData.standardEventName);\n\
    \      assertThat(arguments[3], 'trackSingle called with incorrect event parameters').isEqualTo(eventParams);\n\
    \      index += 1;\n    }\n  };\n});\n     \n// Call runCode to run the template's\
    \ code.\nrunCode(mockData);\n\n// Verify that the tag finished successfully.\n\
    assertThat(index, 'trackSingle called incorrect number of times').isEqualTo(2);\n\
    assertApi('gtmOnSuccess').wasCalled();"
- name: Send custom event
  code: "mockData.eventName = 'custom';\n\nconst eventParams = {\n  prop1: 'val1',\n\
    \  prop2: 'val2'\n};\n\nlet index = 0;\nmock('copyFromWindow', key => {\n  if\
    \ (key === 'fbq') return function() {\n    if (arguments[0] === 'trackSingleCustom')\
    \ {\n      assertThat(arguments[1], 'trackSingleCustom called with incorrect pixel\
    \ ID').isEqualTo(mockData.pixelId.split(',')[index]);\n      assertThat(arguments[2],\
    \ 'trackSingleCustom called with incorrect event name').isEqualTo(mockData.customEventName);\n\
    \      assertThat(arguments[3], 'trackSingleCustom called with incorrect event\
    \ parameters').isEqualTo(eventParams);\n      index += 1;\n    }\n  };\n});\n\
    \     \n// Call runCode to run the template's code.\nrunCode(mockData);\n\n//\
    \ Verify that the tag finished successfully.\nassertThat(index, 'trackSingleCustom\
    \ called incorrect number of times').isEqualTo(2);\nassertApi('gtmOnSuccess').wasCalled();"
- name: Send variable event with standard name
  code: "mockData.eventName = 'variable';\nmockData.variableEventName = 'PageView';\n\
    \nconst eventParams = {\n  prop1: 'val1',\n  prop2: 'val2'\n};\n\nlet index =\
    \ 0;\nmock('copyFromWindow', key => {\n  if (key === 'fbq') return function()\
    \ {\n    if (arguments[0] === 'trackSingle') {\n      assertThat(arguments[1],\
    \ 'trackSingle called with incorrect pixel ID').isEqualTo(mockData.pixelId.split(',')[index]);\n\
    \      assertThat(arguments[2], 'trackSingle called with incorrect event name').isEqualTo(mockData.variableEventName);\n\
    \      assertThat(arguments[3], 'trackSingle called with incorrect event parameters').isEqualTo(eventParams);\n\
    \      index += 1;\n    }\n  };\n});\n     \n// Call runCode to run the template's\
    \ code.\nrunCode(mockData);\n\n// Verify that the tag finished successfully.\n\
    assertThat(index, 'trackSingle called incorrect number of times').isEqualTo(2);\n\
    assertApi('gtmOnSuccess').wasCalled();"
- name: Send variable event with custom name
  code: "mockData.eventName = 'variable';\nmockData.variableEventName = 'custom';\n\
    \nconst eventParams = {\n  prop1: 'val1',\n  prop2: 'val2'\n};\n\nlet index =\
    \ 0;\nmock('copyFromWindow', key => {\n  if (key === 'fbq') return function()\
    \ {\n    if (arguments[0] === 'trackSingleCustom') {\n      assertThat(arguments[1],\
    \ 'trackSingleCustom called with incorrect pixel ID').isEqualTo(mockData.pixelId.split(',')[index]);\n\
    \      assertThat(arguments[2], 'trackSingleCustom called with incorrect event\
    \ name').isEqualTo(mockData.variableEventName);\n      assertThat(arguments[3],\
    \ 'trackSingleCustom called with incorrect event parameters').isEqualTo(eventParams);\n\
    \      index += 1;\n    }\n  };\n});\n     \n// Call runCode to run the template's\
    \ code.\nrunCode(mockData);\n\n// Verify that the tag finished successfully.\n\
    assertThat(index, 'trackSingleCustom called incorrect number of times').isEqualTo(2);\n\
    assertApi('gtmOnSuccess').wasCalled();"
- name: Send event parameters from a variable
  code: "mockData.objectPropertiesFromVariable = {\n  prop1: 'val1',\n  prop2: 'val2'\n\
    };\n\nlet index = 0;\nmock('copyFromWindow', key => {\n  if (key === 'fbq') return\
    \ function() {\n    if (arguments[0] === 'trackSingle') {\n      assertThat(arguments[1],\
    \ 'trackSingle called with incorrect pixel ID').isEqualTo(mockData.pixelId.split(',')[index]);\n\
    \      assertThat(arguments[2], 'trackSingle called with incorrect event name').isEqualTo(mockData.standardEventName);\n\
    \      assertThat(arguments[3], 'trackSingle called with incorrect event parameters').isEqualTo(mockData.objectPropertiesFromVariable);\n\
    \      index += 1;\n    }\n  };\n});\n     \n// Call runCode to run the template's\
    \ code.\nrunCode(mockData);\n\n// Verify that the tag finished successfully.\n\
    assertThat(index, 'trackSingle called incorrect number of times').isEqualTo(2);\n\
    assertApi('gtmOnSuccess').wasCalled();"
- name: Enhanced Ecommerce integration fails with invalid object
  code: |-
    mockData.enhancedEcommerce = true;

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('logToConsole').wasCalledWith('Facebook Pixel: No valid "ecommerce" object found in dataLayer');
    assertApi('gtmOnFailure').wasCalled();
    assertApi('gtmOnSuccess').wasNotCalled();
- name: Enhanced Ecommerce integration fails with invalid action
  code: |-
    mockData.enhancedEcommerce = true;

    mock('copyFromDataLayer', key => {
      if (key === 'ecommerce') return {
        invalid: true
      };
    });

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('logToConsole').wasCalledWith('Facebook Pixel: Most recently pushed "ecommerce" object must be one of types "view_item", "add_to_cart", "begin_checkout" or "purchase".');
    assertApi('gtmOnFailure').wasCalled();
    assertApi('gtmOnSuccess').wasNotCalled();
- name: Enhanced Ecommerce ViewContent works
  code: "mockData.enhancedEcommerce = true;\nmockData.objectPropertyList = {};\n\n\
    mock('copyFromDataLayer', key => {\n  if (key === 'ecommerce') return {\n    currencyCode:\
    \ 'EUR',\n    view_item: {\n      products: mockEec.gtm.products\n    }\n  };\n\
    });\n\nlet index = 0;\nmock('copyFromWindow', key => {\n  if (key === 'fbq') return\
    \ function() {\n    if (arguments[0] === 'trackSingle') {\n      assertThat(arguments[1],\
    \ 'trackSingle called with incorrect pixel ID').isEqualTo(mockData.pixelId.split(',')[index]);\n\
    \      assertThat(arguments[2], 'trackSingle called with incorrect event name').isEqualTo('ViewContent');\n\
    \      assertThat(arguments[3], 'trackSingle called with incorrect event parameters').isEqualTo(mockEec.fb);\n\
    \      index += 1;\n    }\n  };\n});\n     \n// Call runCode to run the template's\
    \ code.\nrunCode(mockData);\n\n// Verify that the tag finished successfully.\n\
    assertThat(index, 'trackSingle called incorrect number of times').isEqualTo(2);\n\
    assertApi('gtmOnSuccess').wasCalled();"
- name: Enhanced Ecommerce AddToCart works
  code: "mockData.enhancedEcommerce = true;\nmockData.objectPropertyList = {};\n\n\
    mock('copyFromDataLayer', key => {\n  if (key === 'ecommerce') return {\n    currencyCode:\
    \ 'EUR',\n    add_to_cart: {\n      products: mockEec.gtm.products\n    }\n  };\n\
    });\n\nlet index = 0;\nmock('copyFromWindow', key => {\n  if (key === 'fbq') return\
    \ function() {\n    if (arguments[0] === 'trackSingle') {\n      assertThat(arguments[1],\
    \ 'trackSingle called with incorrect pixel ID').isEqualTo(mockData.pixelId.split(',')[index]);\n\
    \      assertThat(arguments[2], 'trackSingle called with incorrect event name').isEqualTo('AddToCart');\n\
    \      assertThat(arguments[3], 'trackSingle called with incorrect event parameters').isEqualTo(mockEec.fb);\n\
    \      index += 1;\n    }\n  };\n});\n     \n// Call runCode to run the template's\
    \ code.\nrunCode(mockData);\n\n// Verify that the tag finished successfully.\n\
    assertThat(index, 'trackSingle called incorrect number of times').isEqualTo(2);\n\
    assertApi('gtmOnSuccess').wasCalled();"
- name: Enhanced Ecommerce InitiateCheckout works
  code: "mockData.enhancedEcommerce = true;\nmockEec.fb.num_items = 3;\nmockData.objectPropertyList\
    \ = {};\n\nmock('copyFromDataLayer', key => {\n  if (key === 'ecommerce') return\
    \ {\n    currencyCode: 'EUR',\n    begin_checkout: {\n      products: mockEec.gtm.products\n\
    \    }\n  };\n});\n\nlet index = 0;\nmock('copyFromWindow', key => {\n  if (key\
    \ === 'fbq') return function() {\n    if (arguments[0] === 'trackSingle') {\n\
    \      assertThat(arguments[1], 'trackSingle called with incorrect pixel ID').isEqualTo(mockData.pixelId.split(',')[index]);\n\
    \      assertThat(arguments[2], 'trackSingle called with incorrect event name').isEqualTo('InitiateCheckout');\n\
    \      assertThat(arguments[3], 'trackSingle called with incorrect event parameters').isEqualTo(mockEec.fb);\n\
    \      index += 1;\n    }\n  };\n});\n     \n// Call runCode to run the template's\
    \ code.\nrunCode(mockData);\n\n// Verify that the tag finished successfully.\n\
    assertThat(index, 'trackSingle called incorrect number of times').isEqualTo(2);\n\
    assertApi('gtmOnSuccess').wasCalled();"
- name: Enhanced Ecommerce Purchase works
  code: "mockData.enhancedEcommerce = true;\nmockEec.fb.num_items = 3;\nmockData.objectPropertyList\
    \ = {};\n\nmock('copyFromDataLayer', key => {\n  if (key === 'ecommerce') return\
    \ {\n    currencyCode: 'EUR',\n    purchase: {\n      products: mockEec.gtm.products\n\
    \    }\n  };\n});\n\nlet index = 0;\nmock('copyFromWindow', key => {\n  if (key\
    \ === 'fbq') return function() {\n    if (arguments[0] === 'trackSingle') {\n\
    \      assertThat(arguments[1], 'trackSingle called with incorrect pixel ID').isEqualTo(mockData.pixelId.split(',')[index]);\n\
    \      assertThat(arguments[2], 'trackSingle called with incorrect event name').isEqualTo('Purchase');\n\
    \      assertThat(arguments[3], 'trackSingle called with incorrect event parameters').isEqualTo(mockEec.fb);\n\
    \      index += 1;\n    }\n  };\n});\n     \n// Call runCode to run the template's\
    \ code.\nrunCode(mockData);\n\n// Verify that the tag finished successfully.\n\
    assertThat(index, 'trackSingle called incorrect number of times').isEqualTo(2);\n\
    assertApi('gtmOnSuccess').wasCalled();"
- name: Object merge with variable and list works
  code: "mockData.objectPropertiesFromVariable = {\n  prop1: 'var1',\n  prop2: 'var2',\n\
    \  prop3: 'var3'\n};\n\nconst expected = {\n  prop1: 'val1',\n  prop2: 'val2',\n\
    \  prop3: 'var3'\n};\n\nlet index = 0;\nmock('copyFromWindow', key => {\n  if\
    \ (key === 'fbq') return function() {\n    if (arguments[0] === 'trackSingle')\
    \ {\n      assertThat(arguments[1], 'trackSingle called with incorrect pixel ID').isEqualTo(mockData.pixelId.split(',')[index]);\n\
    \      assertThat(arguments[2], 'trackSingle called with incorrect event name').isEqualTo('PageView');\n\
    \      assertThat(arguments[3], 'trackSingle called with incorrect event parameters').isEqualTo(expected);\n\
    \      index += 1;\n    }\n  };\n});\n     \n// Call runCode to run the template's\
    \ code.\nrunCode(mockData);\n\n// Verify that the tag finished successfully.\n\
    assertThat(index, 'trackSingle called incorrect number of times').isEqualTo(2);\n\
    assertApi('gtmOnSuccess').wasCalled();"
- name: Object merge with variable, list and eec works
  code: "mockData.enhancedEcommerce = true;\nmockData.objectPropertiesFromVariable\
    \ = {\n  content_type: 'product_group'\n};\nmockData.objectPropertyList = [{\n\
    \  name: 'currency',\n  value: 'USD'\n}];\nmockEec.fb.num_items = 3;\nmockEec.fb.content_type\
    \ = 'product_group';\nmockEec.fb.currency = 'USD';\n\nmock('copyFromDataLayer',\
    \ key => {\n  if (key === 'ecommerce') return {\n    currencyCode: 'EUR',\n  \
    \  purchase: {\n      products: mockEec.gtm.products\n    }\n  };\n});\n\nlet\
    \ index = 0;\nmock('copyFromWindow', key => {\n  if (key === 'fbq') return function()\
    \ {\n    if (arguments[0] === 'trackSingle') {\n      assertThat(arguments[1],\
    \ 'trackSingle called with incorrect pixel ID').isEqualTo(mockData.pixelId.split(',')[index]);\n\
    \      assertThat(arguments[2], 'trackSingle called with incorrect event name').isEqualTo('Purchase');\n\
    \      assertThat(arguments[3], 'trackSingle called with incorrect event parameters').isEqualTo(mockEec.fb);\n\
    \      index += 1;\n    }\n  };\n});\n     \n// Call runCode to run the template's\
    \ code.\nrunCode(mockData);\n\n// Verify that the tag finished successfully.\n\
    assertThat(index, 'trackSingle called incorrect number of times').isEqualTo(2);\n\
    assertApi('gtmOnSuccess').wasCalled();"
- name: Send event ID
  code: "mockData.eventId = 'eventId';\n\nmock('copyFromWindow', key => {\n  if (key\
    \ === 'fbq') return function() {\n    if (arguments[0] === 'trackSingle') {\n\
    \      assertThat(arguments[4], 'eventID not included in hit').isEqualTo({eventID:\
    \ mockData.eventId});\n    }\n  };\n});\n     \n// Call runCode to run the template's\
    \ code.\nrunCode(mockData);\n\n// Verify that the tag finished successfully.\n\
    assertApi('gtmOnSuccess').wasCalled();"
setup: "const mockData = {\n  pixelId: '12345,23456',\n  eventName: 'standard',\n\
  \  standardEventName: 'PageView',\n  customEventName: 'custom',\n  variableEventName:\
  \ 'standard',\n  consent: true,\n  advancedMatching: false,\n  advancedMatchingList:\
  \ [{name: 'ct', value: 'Helsinki'},{name: 'cn', value: 'Finland'},{name: 'external_id',\
  \ value: 'UserId'}],\n  objectPropertiesFromVariable: false,\n  objectPropertyList:\
  \ [{name: 'prop1', value: 'val1'},{name: 'prop2', value: 'val2'}],\n  disableAutoConfig:\
  \ false,\n  disablePushState: false,\n  enhancedEcommerce: false,\n  eventId: ''\n\
  };\n\nconst mockEec = {\n  gtm: {  \n    products: [{\n      id: 'i1',\n      name:\
  \ 'n1',\n      category: 'c1',\n      price: '1.00',\n      quantity: 1\n    },{\n\
  \      id: 'i2',\n      name: 'n2',\n      category: 'c2',\n      price: '2.00',\n\
  \      quantity: 2\n    }]\n  },\n  fb: {\n    content_type: 'product',\n    contents:\
  \ [{\n      id: 'i1',\n      quantity: 1\n    },{\n      id: 'i2',\n      quantity:\
  \ 2\n    }],\n    currency: 'EUR',\n    value: 5.00\n  }\n};\n\nconst scriptUrl\
  \ = 'https://connect.facebook.net/en_US/fbevents.js';\n\n// Create injectScript\
  \ mock\nlet success, failure;\nmock('injectScript', (url, onsuccess, onfailure)\
  \ => {\n  success = onsuccess;\n  failure = onfailure;\n  onsuccess();\n});\n\n\
  mock('copyFromWindow', key => {\n  if (key === 'fbq') return () => {};\n});"


___NOTES___

Created on 13.6.2025, 11.36.54


